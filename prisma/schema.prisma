generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. NH√ìM QU·∫¢N L√ù S·∫¢N PH·∫®M & ƒê∆†N V·ªä T√çNH (CORE)
// ==========================================

model products {
  id          Int  @id @default(autoincrement())
  category_id Int?
  brand_id    Int?

  name        String  @db.VarChar
  description String? @db.Text
  image_url   String? @db.VarChar

  // üî• AI SUPPORT FIELDS (Downscope AI)
  // AI s·∫Ω ƒë·ªçc c√°c tr∆∞·ªùng n√†y ƒë·ªÉ t∆∞ v·∫•n thay v√¨ query database ph·ª©c t·∫°p
  indications        String? @db.Text // Ch·ªâ ƒë·ªãnh (Ch·ªØa b·ªánh g√¨?)
  active_ingredients String? @db.Text // Ho·∫°t ch·∫•t (VD: "Paracetamol 500mg") -> Check d·ªã ·ª©ng
  contraindications  String? @db.Text // Ch·ªëng ch·ªâ ƒë·ªãnh/C·∫£nh b√°o
  usage_instructions String? @db.Text // Li·ªÅu d√πng

  // C·ªù qu·∫£n l√Ω
  requires_prescription Boolean @default(false)
  is_active             Boolean @default(true)

  // Cache t·ªìn kho t·ªïng (T√≠nh theo ƒê∆°n v·ªã c∆° b·∫£n - Base Unit)
  total_stock Int @default(0)

  created_at DateTime  @default(now()) @db.Timestamp(6)
  updated_at DateTime? @updatedAt @db.Timestamp(6)

  // RELATIONS
  brands     brands?     @relation(fields: [brand_id], references: [id])
  categories categories? @relation(fields: [category_id], references: [id])

  // ‚úÖ 1. Qu·∫£n l√Ω ƒê√≥ng g√≥i (H·ªôp/V·ªâ/Vi√™n)
  units product_units[]

  // ‚úÖ 2. Kho & Nh·∫≠p h√†ng
  product_batches      product_batches[]
  purchase_order_items purchase_order_items[]

  // ‚úÖ 3. B√°n h√†ng & T∆∞ v·∫•n
  ai_consultations ai_consultations[]
  cart_items       cart_items[]
  order_items      order_items[]
}

// ‚úÖ MODEL M·ªöI: QU·∫¢N L√ù ƒê∆†N V·ªä T√çNH (PACKAGING)
// X·ª≠ l√Ω vi·ªác: H·ªôp (ch·ª©a v·ªâ), L·ªç (ch·ª©a vi√™n), V·ªâ (ch·ª©a vi√™n), ·ªêng, G√≥i...
model product_units {
  id         Int @id @default(autoincrement())
  product_id Int

  unit_name String @db.VarChar // VD: "H·ªôp", "V·ªâ", "Vi√™n", "L·ªç", "G√≥i", "·ªêng"

  // T·ª∑ l·ªá quy ƒë·ªïi ra ƒë∆°n v·ªã nh·ªè nh·∫•t (Base Unit)
  // V√≠ d·ª•: Thu·ªëc A qu·∫£n l√Ω kho theo Vi√™n.
  // - Unit "Vi√™n": factor = 1
  // - Unit "V·ªâ" (10 vi√™n): factor = 10
  // - Unit "H·ªôp" (10 v·ªâ): factor = 100
  conversion_factor Int @default(1)

  price Decimal @db.Decimal // Gi√° b√°n ri√™ng cho ƒë∆°n v·ªã n√†y

  is_base_unit Boolean @default(false) // ƒê√°nh d·∫•u ƒë√¢y l√† ƒë∆°n v·ªã g·ªëc ƒë·ªÉ t√≠nh t·ªìn kho
  is_default   Boolean @default(false) // ƒê∆°n v·ªã hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh khi kh√°ch xem

  // Relations
  product     products      @relation(fields: [product_id], references: [id], onDelete: Cascade)
  cart_items  cart_items[]
  order_items order_items[]
}

model product_batches {
  id           Int    @id @default(autoincrement())
  product_id   Int
  batch_number String @db.VarChar // M√£ l√¥

  // T·ªìn kho th·ª±c t·∫ø (L∆∞u theo Base Unit - ƒê∆°n v·ªã nh·ªè nh·∫•t)
  stock Int @default(0)

  expiry_date        DateTime  @db.Date
  manufacturing_date DateTime? @db.Date
  created_at         DateTime  @default(now()) @db.Timestamp(6)

  products    products      @relation(fields: [product_id], references: [id], onDelete: Cascade)
  order_items order_items[]
}

model brands {
  id          Int        @id @default(autoincrement())
  name        String     @db.VarChar
  description String?
  products    products[]
}

model categories {
  id          Int        @id @default(autoincrement())
  name        String     @db.VarChar
  description String?
  products    products[]
}

// ==========================================
// 2. NH√ìM NH·∫¨P KHO (PURCHASE ORDERS)
// ==========================================

model suppliers {
  id             Int     @id @default(autoincrement())
  name           String  @db.VarChar
  contact_person String? @db.VarChar
  phone          String? @db.VarChar
  email          String? @db.VarChar
  is_active      Boolean @default(true)

  purchase_orders purchase_orders[]
}

model purchase_orders {
  id            Int                 @id @default(autoincrement())
  supplier_id   Int?
  total_amount  Decimal?            @db.Decimal
  status        PurchaseOrderStatus @default(Pending)
  notes         String?
  received_date DateTime?           @db.Timestamp(6)
  created_at    DateTime            @default(now()) @db.Timestamp(6)

  suppliers suppliers?             @relation(fields: [supplier_id], references: [id])
  items     purchase_order_items[]
}

model purchase_order_items {
  id                Int @id @default(autoincrement())
  purchase_order_id Int
  product_id        Int

  quantity  Int // S·ªë l∆∞·ª£ng nh·∫≠p (Th∆∞·ªùng nh·∫≠p theo ƒë∆°n v·ªã l·ªõn nh·∫•t, nh∆∞ng quy ƒë·ªïi ra base unit khi l∆∞u kho)
  unit_cost Decimal @db.Decimal

  // Th√¥ng tin l√¥ h√†ng t·∫°o m·ªõi
  batch_number       String    @db.VarChar
  expiry_date        DateTime  @db.Date
  manufacturing_date DateTime? @db.Date

  purchase_orders purchase_orders @relation(fields: [purchase_order_id], references: [id], onDelete: Cascade)
  products        products        @relation(fields: [product_id], references: [id])
}

// ==========================================
// 3. NH√ìM B√ÅN H√ÄNG (ECOMMERCE CART & ORDER)
// ==========================================

model carts {
  id         Int      @id @default(autoincrement())
  user_id    Int?     @unique // 1 User 1 Cart
  updated_at DateTime @updatedAt

  cart_items cart_items[]
  users      users?       @relation(fields: [user_id], references: [id])
}

model cart_items {
  id         Int @id @default(autoincrement())
  cart_id    Int
  product_id Int

  // ‚úÖ Kh√°ch ch·ªçn mua theo ƒë∆°n v·ªã n√†o? (H·ªôp hay V·ªâ)
  product_unit_id Int

  quantity Int @default(1)

  carts    carts         @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  products products      @relation(fields: [product_id], references: [id])
  unit     product_units @relation(fields: [product_unit_id], references: [id])
}

model orders {
  id         Int  @id @default(autoincrement())
  user_id    Int?
  address_id Int?

  total_amount   Decimal     @db.Decimal
  status         OrderStatus @default(Pending)
  payment_method String?     @db.VarChar

  created_at DateTime  @default(now()) @db.Timestamp(6)
  updated_at DateTime? @updatedAt @db.Timestamp(6)

  order_items order_items[]
  addresses   addresses?    @relation(fields: [address_id], references: [id])
  users       users?        @relation(fields: [user_id], references: [id])
}

model order_items {
  id              Int  @id @default(autoincrement())
  order_id        Int
  product_id      Int
  prescription_id Int?

  // ‚úÖ L∆∞u ƒë∆°n v·ªã ƒë√£ mua ƒë·ªÉ t√≠nh gi√° v√† hi·ªÉn th·ªã l·∫°i l·ªãch s·ª≠
  product_unit_id Int

  quantity Int
  price    Decimal @db.Decimal // Gi√° t·∫°i th·ªùi ƒëi·ªÉm mua (c·ªßa Unit ƒë√≥)

  // Kh√≥a ngo·∫°i l√¥ h√†ng (ƒë·ªÉ bi·∫øt xu·∫•t t·ª´ l√¥ n√†o - FEFO)
  batch_id Int?

  orders          orders           @relation(fields: [order_id], references: [id])
  products        products         @relation(fields: [product_id], references: [id])
  product_batches product_batches? @relation(fields: [batch_id], references: [id])
  unit            product_units    @relation(fields: [product_unit_id], references: [id])
  prescriptions   prescriptions?   @relation(fields: [prescription_id], references: [id])
}

// ==========================================
// 4. NH√ìM NG∆Ø·ªúI D√ôNG & Y T·∫æ (USERS & HEALTH)
// ==========================================

model users {
  id             Int      @id @default(autoincrement())
  email          String   @unique @db.VarChar
  password       String?  @db.VarChar
  name           String?  @db.VarChar
  phone          String?  @db.VarChar
  role           Role     @default(patient)
  loyalty_points Int      @default(0)
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now()) @db.Timestamp(6)

  addresses        addresses[]
  ai_consultations ai_consultations[]
  carts            carts[]
  orders           orders[]
  prescriptions    prescriptions[]
  pharmacists      pharmacists[]

  // Th√¥ng tin s·ª©c kh·ªèe (D·ªã ·ª©ng...)
  user_health_profiles user_health_profiles?
}

model user_health_profiles {
  user_id Int @id

  // üî• AI DATA: L∆∞u d·ªã ·ª©ng d·∫°ng text ƒë·ªÉ AI ƒë·ªçc
  // VD: "D·ªã ·ª©ng Penicillin, m·∫´n c·∫£m v·ªõi Aspirin"
  allergies           String? @db.Text
  chronic_conditions  String? @db.Text
  current_medications String? @db.Text

  updated_at DateTime? @updatedAt
  users      users     @relation(fields: [user_id], references: [id])
}

model addresses {
  id           Int     @id @default(autoincrement())
  user_id      Int?
  full_name    String? @db.VarChar
  phone        String? @db.VarChar
  address_line String? @db.VarChar
  city         String? @db.VarChar
  province     String? @db.VarChar
  is_default   Boolean @default(false)

  users  users?   @relation(fields: [user_id], references: [id])
  orders orders[]
}

model pharmacists {
  id         Int     @id @default(autoincrement())
  user_id    Int     @unique
  license_no String  @unique @db.VarChar
  approved   Boolean @default(false)

  users         users           @relation(fields: [user_id], references: [id])
  prescriptions prescriptions[]
}

model prescriptions {
  id            Int  @id @default(autoincrement())
  user_id       Int
  pharmacist_id Int? // Ng∆∞·ªùi duy·ªát ƒë∆°n

  image_url  String             @db.VarChar
  status     PrescriptionStatus @default(Pending)
  admin_note String? // Ghi ch√∫ c·ªßa d∆∞·ª£c sƒ© (VD: "T·ª´ ch·ªëi v√¨ ·∫£nh m·ªù")

  created_at DateTime  @default(now()) @db.Timestamp(6)
  updated_at DateTime? @updatedAt

  order_items order_items[]
  pharmacists pharmacists?  @relation(fields: [pharmacist_id], references: [id])
  users       users         @relation(fields: [user_id], references: [id])
}

// üî• AI CONSULTATION (Downscoped)
// Ch·ªâ l∆∞u input/output d·∫°ng text. Logic x·ª≠ l√Ω d·ªã ·ª©ng n·∫±m ·ªü Backend/AI Service.
model ai_consultations {
  id      Int  @id @default(autoincrement())
  user_id Int?

  symptoms_input String @db.Text // User: "ƒêau b·ª•ng, bu·ªìn n√¥n"
  ai_analysis    String @db.Text // AI: "C√≥ th·ªÉ l√† r·ªëi lo·∫°n ti√™u h√≥a. G·ª£i √Ω thu·ªëc..."

  // N·∫øu AI g·ª£i √Ω s·∫£n ph·∫©m c·ª• th·ªÉ, l∆∞u ID ƒë·ªÉ tracking (Optional)
  suggested_product_id Int?

  created_at DateTime @default(now()) @db.Timestamp(6)

  products products? @relation(fields: [suggested_product_id], references: [id])
  users    users?    @relation(fields: [user_id], references: [id])
}

// ==========================================
// 5. ENUMS
// ==========================================

enum PurchaseOrderStatus {
  Pending
  Received
  Cancelled
}

enum PrescriptionStatus {
  Pending
  Approved
  Rejected
}

enum Role {
  patient
  pharmacist
  admin
}

enum OrderStatus {
  Pending
  Processing
  Shipped
  Delivered
  Cancelled
}
